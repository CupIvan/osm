<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

	<script src="/i/lib.js"></script>
	<script src="/i/osm.js"></script>

	<style>
		#map  { width: 100%; height: 100%; position: absolute; left: 0; top: 0; }
		#info { position: absolute; left: 50%; margin-left: -300px; width: 600px; text-align: center;
			padding: 10px 20px; background: #DDD; border: 2px solid #000; opacity: 0.9; z-index: 999; }
		.ref  { font-weight: bold; box-shadow: none; border: 0; background: none; }
	</style>
</head>

<body>

<div id="info"></div>
<div id="map"></div>

<script>
var H = {};
var i, a, t = document.location.hash.replace(/.+?\?/, '').split('&');
for (i = 0; i < t.length; i++) { a = t[i].split('='); H[a[0]] = a[1]; }

var map = L.map('map').setView([H.lat||56.30, H.lon||43.97], H.z||12);
var markers = {}, lines = {};
var stat = {n:0, nk:0, ne: 0, n_ref:0};

if (!H.lat) map.locate()

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
	maxZoom: 20,
	maxNativeZoom: 18,
}).addTo(map);

var g_osm_objects = {}

map.createPane('circlePane').style.zIndex = 410
map.on('popupopen', function(e){ if (e.popup.options.osm_id) e.popup.setContent(make_popup(g_osm_objects[e.popup.options.osm_id])); });

/** типы зданий */
var architecure = {
	'stalinist neoclassicism': { color: '#0F0', title: 'сталинский ампир' },
	'romanesque':              { color: '#00F', title: 'романская архитектура', },
	'gothic':                  { color: '#0FF', title: 'готическая архитектура', },
	'renaissance':             { color: '#F0F', title: 'архитектура возрождения', },
	'neoclassicism':           { color: '#FF0', title: 'неоклассицизм', },
	'art_nouveau':             { color: '#FFF', title: 'модерн' },
	'modern':                  { color: '#070', title: 'модернизм', },
	'modernism':               { color: '#F00', title: 'модерн (устаревший тег - нужно заменить на art_nouveau)' },
	'new_objectivity':         { color: '#007', title: 'новая вещественность' },
	'constructivism':          { color: '#077', title: 'конструктивизм' },
	'postconstructivism':      { color: '#707', title: 'постконструктивизм' },
	'contemporary':            { color: '#770', title: 'архитектура 21 века' },
	'eclectic':                { color: '#07F', title: 'эклектизм' },
}
function getBuildingColor(a)
{
	var x
	c = '#777'
	if (a.tags)
	if (x = a.tags['building:architecture'])
	if (architecure[x])
		c = architecure[x].color
	else c = '#000'
	return c
}

/** содержимое popup на здании */
function make_popup(a)
{
	var x, st = ''
	if (a.tags['building'] == 'apartments') st += '<b>Многоэтажный жилой дом</b><br><br>'
	if (a.tags['building'] == 'yes')        st += '<b>Здание</b><br><br>'

	if (!(x=a.tags['building:architecture']))
		st += 'Стиль: <b>не указан</b><br>'
	else
		st += 'Стиль: <b>'+(architecure[x]?architecure[x].title:x)+'</b><br>'

	if (a.tags['building:levels'])
		st += 'Этажей: <i>'+a.tags['building:levels']+'</i><br>'

	if (a.tags['addr:housenumber'])
		st += 'Номер дома: <i>'+a.tags['addr:housenumber']+'</i><br>'

	if (a.tags['addr:street'])
		st += 'Улица: <i>'+a.tags['addr:street']+'</i><br>'

	st += '<br><small>#'+a.id+'</small>'

	return st;
}

/** основная функция для загрузки и отрисовки геометрии */
function draw()
{
	var hash = '?z='+map.getZoom(), msg;
	var a = map.getCenter();
	hash += '&lat='+a.lat+'&lon='+a.lng;
	hash = '#'+(Math.round(a.lat*a.lat/10+a.lng*a.lng/10))+'/'+hash;
	document.location = hash;

	if (map.getZoom() >= 16)
	{
		osm.search({'building:architecture':true, bounds: map.getBounds().toBBoxString().split(',')}, function(data){
			if (!data.length) return $('info', 'Нет данных')
			$('info', 'Данные загружены')
			var i, a
			for (i=0; i<data.length; i++)
			{
				a = data[i];
				g_osm_objects[a.id] = a
				c = getBuildingColor(a)
				if (!lines[a.id])
				lines[a.id] = L.polygon(a.geo, { color: c, weight: 2, fillColor: c })
					.addTo(map)
					.bindPopup('', { osm_id: a.id })
			}
		})

		msg = 'Загрузка...';
	} else
		msg = 'Для отображения данных необходимо увеличить масштаб карты.<br>'
			+' <a href="https://forum.openstreetmap.org/viewtopic.php?pid=635464">Отзывы</a> и'
			+' <a href="https://wiki.openstreetmap.org/wiki/RU:Key:building:architecture">Справка по разметке</a>';

	$('info', msg);
}

map.on('moveend', draw);
draw();

</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter13902487 = new Ya.Metrika({id:13902487, enableAll: true, trackHash:true, webvisor:true}); } catch(e) {} }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script>
<noscript><div><img src="//mc.yandex.ru/watch/13902487" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->

</body>
</html>
